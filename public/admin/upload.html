<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduink Admin - Upload</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="admin-style.css">
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" href="../icons/logo.png" type="image/png">
</head>
<body class="admin-body">
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="admin-logo">
            <img src="../icons/logo.png" alt="Eduink Logo" class="logo-img">
            Eduink Admin - Upload Content
        </div>
        <nav class="admin-nav">
            <a href="/admin/dashboard" class="admin-nav-link">Back to Dashboard</a>
            <button class="admin-nav-link admin-logout-btn" onclick="logout()">Logout</button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="admin-main-container">
        <!-- TAB NAVIGATION -->
        <div class="admin-tabs">
            <button class="admin-tab-btn active" onclick="switchTab('questions')">Upload Questions</button>
            <button class="admin-tab-btn" onclick="switchTab('notes')">Upload Notes</button>
            <button class="admin-tab-btn" onclick="switchTab('manage')">Manage Content</button>
        </div>

        <!-- QUESTIONS TAB -->
        <div id="questions-tab" class="admin-upload-container">
            <h2>Upload Question Papers</h2>
            <p class="admin-subtitle">Add PDF or image files for questions</p>

            <form id="uploadQuestionForm" class="admin-upload-form">
                <div class="admin-form-group">
                    <label for="uploadClass">Class:</label>
                    <select id="uploadClass" required>
                        <option value="">Select Class</option>
                        <option value="9th">9th</option>
                        <option value="10th">10th</option>
                        <option value="11th">11th</option>
                        <option value="12th">12th</option>
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="uploadSubject">Subject:</label>
                    <input 
                        type="text" 
                        id="uploadSubject" 
                        required 
                        placeholder="e.g., Mathematics"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="uploadTitle">Question Paper Title:</label>
                    <input 
                        type="text" 
                        id="uploadTitle" 
                        required 
                        placeholder="e.g., March 2025 Exam"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="uploadFile">Select File (PDF/Image):</label>
                    <div class="admin-file-input-wrapper">
                        <input 
                            type="file" 
                            id="uploadFile" 
                            accept=".pdf,.jpg,.jpeg,.png"
                            required
                            onchange="updateFileName()"
                        >
                        <span id="fileName" class="admin-file-name">No file selected</span>
                    </div>
                </div>

                <button type="submit" class="admin-btn-upload">Upload Question Paper</button>

                <p id="uploadMsg" class="admin-message" style="display: none;"></p>
            </form>

            <!-- Upload Progress -->
            <div id="uploadProgress" style="display: none;">
                <div class="admin-progress-bar">
                    <div id="progressFill" class="admin-progress-fill"></div>
                </div>
                <p id="progressText">Uploading...</p>
            </div>
        </div>

        <!-- NOTES TAB -->
        <div id="notes-tab" class="admin-upload-container" style="display: none;">
            <h2>üìö Upload Study Notes</h2>
            <p class="admin-subtitle">Add PDF notes with captions for students</p>

            <form id="uploadNotesForm" class="admin-upload-form">
                <!-- Class Dropdown -->
                <div class="admin-form-group">
                    <label for="notesClass">Select Standard:</label>
                    <select id="notesClass" required onchange="onClassChange()">
                        <option value="">Loading classes...</option>
                    </select>
                </div>

                <!-- Subject Dropdown (dynamically populated) -->
                <div class="admin-form-group">
                    <label for="notesSubject">Select Subject:</label>
                    <select id="notesSubject" required>
                        <option value="">Select a standard first</option>
                    </select>
                </div>

                <!-- Notes Title -->
                <div class="admin-form-group">
                    <label for="notesTitle">Notes Title:</label>
                    <input 
                        type="text" 
                        id="notesTitle" 
                        required 
                        placeholder="e.g., Chapter 1: Mechanics"
                    >
                </div>

                <!-- Caption/Description -->
                <div class="admin-form-group">
                    <label for="notesCaption">Caption/Description:</label>
                    <textarea 
                        id="notesCaption" 
                        placeholder="Brief description of the notes (optional)"
                        rows="3"
                    ></textarea>
                </div>

                <!-- File Upload -->
                <div class="admin-form-group">
                    <label for="notesFile">Select PDF File:</label>
                    <div class="admin-file-input-wrapper">
                        <input 
                            type="file" 
                            id="notesFile" 
                            accept=".pdf"
                            required
                            onchange="updateNotesFileName()"
                        >
                        <span id="notesFileName" class="admin-file-name">No file selected</span>
                    </div>
                </div>

                <button type="submit" class="admin-btn-upload">Upload Notes</button>

                <p id="uploadNotesMsg" class="admin-message" style="display: none;"></p>
            </form>

            <!-- Upload Progress for Notes -->
            <div id="uploadNotesProgress" style="display: none;">
                <div class="admin-progress-bar">
                    <div id="notesProgressFill" class="admin-progress-fill"></div>
                </div>
                <p id="notesProgressText">Uploading notes...</p>
            </div>
        </div>

        <!-- MANAGE CONTENT TAB -->
        <div id="manage-tab" class="admin-upload-container" style="display: none;">
            <h2>Manage Content</h2>
            <p class="admin-subtitle">Delete notes, questions, or videos</p>

            <!-- Delete Notes -->
            <div style="margin-bottom: 3rem;">
                <h3 style="color: #667eea; margin-bottom: 1.5rem;">üìö Delete Notes</h3>
                <div id="notesList" class="admin-content-list">
                    <div class="loading-item">Loading notes...</div>
                </div>
            </div>

            <!-- Delete Questions -->
            <div style="margin-bottom: 3rem;">
                <h3 style="color: #667eea; margin-bottom: 1.5rem;">üìÑ Delete Questions</h3>
                <div id="questionsList" class="admin-content-list">
                    <div class="loading-item">Loading questions...</div>
                </div>
            </div>

            <!-- Delete Videos -->
            <div style="margin-bottom: 3rem;">
                <h3 style="color: #667eea; margin-bottom: 1.5rem;">üé• Delete Videos</h3>
                <div id="videosList" class="admin-content-list">
                    <div class="loading-item">Loading videos...</div>
                </div>
            </div>
        </div>

        <!-- Uploaded Files List (for Questions) -->
        <div class="admin-uploads-list" id="filesListContainer">
            <h3>Recently Uploaded Files</h3>
            <div id="uploadsList" class="admin-files-grid">
                <p style="color: #999;">Files will appear here after upload</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="admin-footer">
        <p>&copy; 2026 Eduink Admin. All rights reserved.</p>
    </footer>

    <script>
        // ============================================
        // AUTHENTICATION
        // ============================================

        /**
         * Check if admin is logged in via localStorage
         * Redirect to login if not authenticated
         */
        function checkAdminAuth() {
            try {
                const sessionData = JSON.parse(localStorage.getItem('adminSession'));
                if (!sessionData || !sessionData.loggedIn) {
                    window.location.href = '/admin';
                }
            } catch (error) {
                window.location.href = '/admin';
            }
        }

        /**
         * Logout admin user
         * Clear session and redirect to login
         */
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminSession');
                window.location.href = '/admin';
            }
        }

        // ============================================
        // TAB SWITCHING
        // ============================================

        /**
         * Switch between Questions, Notes, and Manage Content tabs
         * Hide/show appropriate content
         */
        function switchTab(tabName) {
            // Hide all tabs
            document.getElementById('questions-tab').style.display = 'none';
            document.getElementById('notes-tab').style.display = 'none';
            document.getElementById('manage-tab').style.display = 'none';
            document.getElementById('filesListContainer').style.display = 
                tabName === 'questions' ? 'block' : 'none';

            // Show selected tab
            if (tabName !== 'manage') {
                document.getElementById(tabName + '-tab').style.display = 'block';
            } else {
                document.getElementById('manage-tab').style.display = 'block';
                loadManageContent();
            }

            // Update button styles
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Load classes when Notes tab is opened
            if (tabName === 'notes') {
                loadClasses();
            }
        }

        // ============================================
        // QUESTIONS UPLOAD
        // ============================================

        /**
         * Update question file name display in form
         */
        function updateFileName() {
            const fileInput = document.getElementById('uploadFile');
            const fileName = document.getElementById('fileName');
            
            if (fileInput.files && fileInput.files[0]) {
                fileName.textContent = fileInput.files[0].name;
            } else {
                fileName.textContent = 'No file selected';
            }
        }

        /**
         * Handle question upload form submission
         * Upload to /api/upload-question endpoint
         */
        document.getElementById('uploadQuestionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('class', document.getElementById('uploadClass').value);
            formData.append('subject', document.getElementById('uploadSubject').value);
            formData.append('title', document.getElementById('uploadTitle').value);
            formData.append('file', document.getElementById('uploadFile').files[0]);

            const progressDiv = document.getElementById('uploadProgress');
            const msgElement = document.getElementById('uploadMsg');

            try {
                progressDiv.style.display = 'block';

                const response = await fetch('/api/upload-question', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    msgElement.textContent = '‚úÖ Question uploaded successfully!';
                    msgElement.className = 'admin-message success';
                    document.getElementById('uploadQuestionForm').reset();
                    updateFileName();
                } else {
                    msgElement.textContent = '‚ùå Error: ' + (result.message || 'Upload failed');
                    msgElement.className = 'admin-message error';
                }

                msgElement.style.display = 'block';
                progressDiv.style.display = 'none';

            } catch (error) {
                console.error('Upload error:', error);
                msgElement.textContent = '‚ùå Error uploading file: ' + error.message;
                msgElement.className = 'admin-message error';
                msgElement.style.display = 'block';
                progressDiv.style.display = 'none';
            }
        });

        // ============================================
        // NOTES UPLOAD
        // ============================================

        /**
         * Load all classes and populate the dropdown
         * Fetches from /api/classes endpoint
         */
        async function loadClasses() {
            try {
                const response = await fetch('/api/classes');
                const classes = await response.json();

                const dropdown = document.getElementById('notesClass');
                dropdown.innerHTML = '<option value="">Select Standard</option>';

                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem;
                    option.textContent = classItem;
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
                document.getElementById('notesClass').innerHTML = 
                    '<option value="">Error loading classes</option>';
            }
        }

        /**
         * Handle class selection change
         * Load subjects for the selected class
         */
        async function onClassChange() {
            const selectedClass = document.getElementById('notesClass').value;
            
            const subjectDropdown = document.getElementById('notesSubject');
            
            if (!selectedClass) {
                subjectDropdown.innerHTML = '<option value="">Select a standard first</option>';
                return;
            }

            try {
                // Fetch subjects for the selected class
                const response = await fetch(`/api/subjects/${selectedClass}`);
                const subjects = await response.json();

                subjectDropdown.innerHTML = '<option value="">Select Subject</option>';

                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectDropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading subjects:', error);
                subjectDropdown.innerHTML = 
                    '<option value="">Error loading subjects</option>';
            }
        }

        /**
         * Update notes file name display in form
         */
        function updateNotesFileName() {
            const fileInput = document.getElementById('notesFile');
            const fileName = document.getElementById('notesFileName');
            
            if (fileInput.files && fileInput.files[0]) {
                fileName.textContent = fileInput.files[0].name;
            } else {
                fileName.textContent = 'No file selected';
            }
        }

        /**
         * Handle notes upload form submission
         * Upload PDF and metadata to /api/upload-notes endpoint
         * 
         * Process:
         * 1. Validate class and subject selection
         * 2. Validate PDF file
         * 3. Upload to Supabase storage
         * 4. Store metadata in notes table
         * 5. Show success/error message
         */
        document.getElementById('uploadNotesForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect form data
            const classItem = document.getElementById('notesClass').value;
            const subject = document.getElementById('notesSubject').value;
            const title = document.getElementById('notesTitle').value;
            const caption = document.getElementById('notesCaption').value;
            const file = document.getElementById('notesFile').files[0];

            // Validate inputs
            if (!classItem) {
                alert('Please select a standard');
                return;
            }

            if (!subject) {
                alert('Please select a subject');
                return;
            }

            if (!file) {
                alert('Please select a PDF file');
                return;
            }

            if (file.type !== 'application/pdf') {
                alert('Only PDF files are allowed');
                return;
            }

            // Create FormData
            const formData = new FormData();
            formData.append('class', classItem);
            formData.append('subject', subject);
            formData.append('title', title);
            formData.append('caption', caption);
            formData.append('file', file);

            const progressDiv = document.getElementById('uploadNotesProgress');
            const msgElement = document.getElementById('uploadNotesMsg');

            try {
                // Show progress bar
                progressDiv.style.display = 'block';

                // Send to backend
                const response = await fetch('/api/upload-notes', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    msgElement.textContent = '‚úÖ Notes uploaded successfully!';
                    msgElement.className = 'admin-message success';
                    
                    // Reset form
                    document.getElementById('uploadNotesForm').reset();
                    updateNotesFileName();
                    
                    // Show success for 3 seconds then hide
                    setTimeout(() => {
                        msgElement.style.display = 'none';
                    }, 3000);
                } else {
                    msgElement.textContent = '‚ùå Error: ' + (result.message || 'Upload failed');
                    msgElement.className = 'admin-message error';
                }

                msgElement.style.display = 'block';
                progressDiv.style.display = 'none';

            } catch (error) {
                console.error('Upload error:', error);
                msgElement.textContent = '‚ùå Error uploading notes: ' + error.message;
                msgElement.className = 'admin-message error';
                msgElement.style.display = 'block';
                progressDiv.style.display = 'none';
            }
        });

        // ============================================
        // MANAGE CONTENT (DELETE FUNCTIONALITY)
        // ============================================

        /**
         * Load all content (notes, questions, videos)
         * Fetch from backend and display in manage tab
         */
        async function loadManageContent() {
            loadNotesForDelete();
            loadQuestionsForDelete();
            loadVideosForDelete();
        }

        /**
         * Load notes and display delete buttons
         */
        async function loadNotesForDelete() {
            try {
                const response = await fetch('/api/all-notes');
                const notes = await response.json();

                const container = document.getElementById('notesList');
                container.innerHTML = '';

                if (!notes || notes.length === 0) {
                    container.innerHTML = '<div class="empty-content">No notes found</div>';
                    return;
                }

                notes.forEach(note => {
                    const item = document.createElement('div');
                    item.className = 'content-item';
                    item.innerHTML = `
                        <div class="content-info">
                            <h4>${note.title}</h4>
                            <p>Class: <strong>${note.class}</strong> | Subject: <strong>${note.subject}</strong></p>
                            <p style="font-size: 0.8rem; color: #999;">ID: ${note.id}</p>
                        </div>
                        <div class="content-item-actions">
                            <button class="btn-delete" onclick="deleteNote('${note.id}', '${note.title}')">Delete</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('notesList').innerHTML = '<div class="empty-content">Error loading notes</div>';
            }
        }

        /**
         * Load questions and display delete buttons
         */
        async function loadQuestionsForDelete() {
            try {
                const response = await fetch('/api/all-questions');
                const questions = await response.json();

                const container = document.getElementById('questionsList');
                container.innerHTML = '';

                if (!questions || questions.length === 0) {
                    container.innerHTML = '<div class="empty-content">No questions found</div>';
                    return;
                }

                questions.forEach(question => {
                    const item = document.createElement('div');
                    item.className = 'content-item';
                    item.innerHTML = `
                        <div class="content-info">
                            <h4>${question.title}</h4>
                            <p>Class: <strong>${question.class}</strong> | Subject: <strong>${question.subject}</strong></p>
                            <p style="font-size: 0.8rem; color: #999;">ID: ${question.id}</p>
                        </div>
                        <div class="content-item-actions">
                            <button class="btn-delete" onclick="deleteQuestion('${question.id}', '${question.title}')">Delete</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('questionsList').innerHTML = '<div class="empty-content">Error loading questions</div>';
            }
        }

        /**
         * Load videos and display delete buttons
         */
        async function loadVideosForDelete() {
            try {
                const response = await fetch('/api/all-videos');
                const videos = await response.json();

                const container = document.getElementById('videosList');
                container.innerHTML = '';

                if (!videos || videos.length === 0) {
                    container.innerHTML = '<div class="empty-content">No videos found</div>';
                    return;
                }

                videos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'content-item';
                    item.innerHTML = `
                        <div class="content-info">
                            <h4>${video.title}</h4>
                            <p>Class: <strong>${video.class}</strong> | Subject: <strong>${video.subject}</strong></p>
                            <p style="font-size: 0.8rem; color: #999;">ID: ${video.id} | URL: ${video.video_url}</p>
                        </div>
                        <div class="content-item-actions">
                            <button class="btn-delete" onclick="deleteVideo('${video.id}', '${video.title}')">Delete</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading videos:', error);
                document.getElementById('videosList').innerHTML = '<div class="empty-content">Error loading videos</div>';
            }
        }

        /**
         * Delete a note by ID
         */
        async function deleteNote(noteId, noteTitle) {
            if (!confirm(`Are you sure you want to delete: "${noteTitle}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-note/${noteId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('‚úÖ Note deleted successfully!');
                    loadNotesForDelete();
                } else {
                    alert('‚ùå Error deleting note');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå Error deleting note');
            }
        }

        /**
         * Delete a question by ID
         */
        async function deleteQuestion(questionId, questionTitle) {
            if (!confirm(`Are you sure you want to delete: "${questionTitle}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-question/${questionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('‚úÖ Question deleted successfully!');
                    loadQuestionsForDelete();
                } else {
                    alert('‚ùå Error deleting question');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå Error deleting question');
            }
        }

        /**
         * Delete a video by ID
         */
        async function deleteVideo(videoId, videoTitle) {
            if (!confirm(`Are you sure you want to delete: "${videoTitle}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-video/${videoId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('‚úÖ Video deleted successfully!');
                    loadVideosForDelete();
                } else {
                    alert('‚ùå Error deleting video');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå Error deleting video');
            }
        }

        // ============================================
        // PAGE INITIALIZATION
        // ============================================

        /**
         * On page load:
         * 1. Check admin authentication
         * 2. Load classes for the notes dropdown
         */
        window.addEventListener('load', () => {
            checkAdminAuth();
            loadClasses();
        });
    </script>
</body>
</html>
